!function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.WebSocketClient=t()}(this,function(){"use strict";var i;if("WebSocket"in window)i=WebSocket;else{if(!("MozWebSocket"in window))throw new Error("you browser do not support WebSocket");i=MozWebSocket}function r(){this._stores={}}function a(e,t){for(var o in this.event=new r,this.websocket=null,this.url="",this.path="",this.query={},this.protocols=void 0,this.automaticOpen=!0,this.reconnectAttempts=0,this.reconnectInterval=1e3,this.reconnectDecay=1.5,this.maxReconnectInterval=3e4,this.maxReconnectAttempts=null,this.openTimeoutInterval=2e3,this.binaryType="blob",this.pingInterval=5e4,this.pingData="ping",this.typeKey="type",this.payloadKey="payload",this.normalCloseCode=[1e3],this.messageQueue=[],this.messageQueueTimeout=3e5,this.protocol=null,this.readyState=null,this.heartCheckTimer=null,t=t||{}){if(!this.hasOwnProperty(o))throw new Error('this option "'+o+'" is not defined');this[o]=t[o]}var n,s=function(e){if(!(r=e.match(/^([\w-]+):\/\/([\w.-]+)(?::(\d+))?(\/\w*)?(?:\?([\w=&]+))?(?:#([\w-]+))?$/)))throw new TypeError("url parameter error: "+e);var t=r[1],o=r[2],n=r[3],s=r[4]||"",e=r[5],r=r[6]||"",i={};return e&&e.split("&").forEach(function(e){e=e.split("=");i[e[0]]=e[1]}),{protocol:t,host:o,port:n,path:s,queryParams:i,hash:r}}(e);for(n in this.path&&(s.path=this.path),this.query)s.queryParams[n]=this.query[n];this.url=function(e){var t=e.protocol+"://"+e.host;e.port&&(t+=":"+e.port),e.path&&(t+=e.path);var o,n=[];for(o in e.queryParams){var s=e.queryParams[o];n.push(encodeURIComponent(o)+"="+encodeURIComponent(s))}return 0<n.length&&(t+="?"+n.join("&")),e.hash&&(t+="#"+e.hash),t}(s),this.readyState=i.CONNECTING,!0===this.automaticOpen&&this.open(!1)}return r.prototype.on=function(e,t,o){if("function"!=typeof t)throw new Error("listener must be a function");this._stores[e]||(this._stores[e]=[]),this._stores[e].push({cb:t,ctx:o})},r.prototype.emit=function(e){var t=this._stores[e];if(t){for(var o=Array.prototype.slice.call(arguments,1),n=0;n<t.length;n++)t[n].cb.apply(t[n].ctx,o);return!0}},r.prototype.off=function(e,t){if(arguments.length){var o=this._stores[e];if(!o)return!1;if(t)for(var n=o.length-1;0<=n;n--)o[n].cb===t&&o.splice(n,1);else this._stores[e]=[]}else this._stores={}},a.CONNECTING=i.CONNECTING,a.OPEN=i.OPEN,a.CLOSING=i.CLOSING,a.CLOSED=i.CLOSED,a.EVENT={OPEN:"open",CLOSE:"close",ERROR:"error",MESSAGE:"message",CONNECTING:"connecting"},a.prototype.open=function(e){var n=this;if(!this.websocket||this.websocket.readyState!==i.OPEN){var s=new WebSocket(this.url,this.protocols);if((this.websocket=s).binaryType=this.binaryType,e){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else this.event.emit(a.EVENT.CONNECTING),this.reconnectAttempts=0;var r=setTimeout(function(){s&&s.close()},this.openTimeoutInterval);s.onopen=function(e){clearTimeout(this.heartCheckTimer),clearTimeout(r),n.protocol=s.protocol,n.readyState=i.OPEN,n.reconnectAttempts=0,n.event.emit(a.EVENT.OPEN,e),n.heartCheckStart();for(var t=new Date;0<n.messageQueue.length;){var o=n.messageQueue.shift();(n.messageQueueTimeout<=0||t-o.pushTime<=n.messageQueueTimeout)&&n.sendRaw(o.message)}},s.onclose=function(e){if(clearTimeout(this.heartCheckTimer),clearTimeout(r),s=null,n.websocket=null,function(e,t){for(var o=0;o<e.length;o++)if(e[o]===t)return 1}(n.normalCloseCode,e.code))return n.readyState=i.CLOSED,void n.event.emit(a.EVENT.CLOSE,e);n.readyState=i.CONNECTING,n.event.emit(a.EVENT.CONNECTING,e);e=Math.min(n.maxReconnectInterval,n.reconnectInterval*Math.pow(n.reconnectDecay,n.reconnectAttempts));setTimeout(function(){n.reconnectAttempts++,n.open(!0)},e)},s.onmessage=function(e){n.event.emit(a.EVENT.MESSAGE,e.data);try{var t=JSON.parse(e.data);"object"==typeof t&&t[n.typeKey]&&n.event.emit(t[n.typeKey],t[n.payloadKey])}catch(e){}},s.onerror=function(e){n.event.emit(a.EVENT.ERROR,e)}}},a.prototype.on=function(e,t){return this.event.on(e,t,this),this},a.prototype.off=function(e,t){return this.event.off(e,t),this},a.prototype.send=function(e,t){if(!e||"string"!=typeof e)throw TypeError("type must be a string");var o={};return o[this.typeKey]=e,o[this.payloadKey]=t,this.sendRaw(o)},a.prototype.sendRaw=function(e){this.readyState===i.OPEN?this.websocket&&("object"!=typeof e||e instanceof ArrayBuffer||e instanceof Blob?this.websocket.send(e):null==e?this.websocket.send(""):this.websocket.send(JSON.stringify(e))):this.messageQueue.push({pushTime:new Date,message:e})},a.prototype.close=function(e,t){void 0===e&&(e=1e3),this.websocket&&this.websocket.close(e,t)},a.prototype.heartCheckStart=function(){var e;!1!==this.pingInterval&&(e=this,clearTimeout(this.heartCheckTimer),this.heartCheckTimer=setTimeout(function(){e.readyState===i.OPEN&&(e.sendRaw(e.pingData),e.heartCheckStart())},this.pingInterval))},a});