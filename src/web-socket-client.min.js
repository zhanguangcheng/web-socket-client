!function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.WebSocketClient=t()}(this,function(){"use strict";var a;if("WebSocket"in window)a=WebSocket;else{if(!("MozWebSocket"in window))throw new Error("you browser do not support WebSocket");a=MozWebSocket}function s(){this._stores={}}function h(e,t){for(var o in this.event=new s,this.websocket=null,this.url="",this.path="",this.query={},this.protocols=void 0,this.automaticOpen=!0,this.reconnectAttempts=0,this.reconnectInterval=1e3,this.reconnectDecay=1.5,this.maxReconnectInterval=3e4,this.maxReconnectAttempts=null,this.openTimeoutInterval=2e3,this.binaryType="blob",this.pingInterval=5e4,this.pingData="ping",this.typeKey="type",this.payloadKey="payload",this.normalCloseCode=[1e3],this.messageQueue=[],this.messageQueueTimeout=3e5,this.protocol=null,this.readyState=null,this.heartCheckTimer=null,t=t||{}){if(!this.hasOwnProperty(o))throw new Error('this option "'+o+'" is not defined');this[o]=t[o]}var n,r=function(e){if(!(s=e.match(/^([\w-]+):\/\/([\w.-]+)(?::(\d+))?(\/\w*)?(?:\?([\w=&]+))?(?:#([\w-]+))?$/)))throw new TypeError("url parameter error: "+e);var t=s[1],o=s[2],n=s[3],r=s[4]||"",e=s[5],s=s[6]||"",i={};return e&&e.split("&").forEach(function(e){e=e.split("=");i[e[0]]=e[1]}),{protocol:t,host:o,port:n,path:r,queryParams:i,hash:s}}(e);for(n in this.path&&(r.path=this.path),this.query)r.queryParams[n]=this.query[n];this.url=function(e){var t=e.protocol+"://"+e.host;e.port&&(t+=":"+e.port),e.path&&(t+=e.path);var o,n=[];for(o in e.queryParams){var r=e.queryParams[o];n.push(encodeURIComponent(o)+"="+encodeURIComponent(r))}return 0<n.length&&(t+="?"+n.join("&")),e.hash&&(t+="#"+e.hash),t}(r),this.readyState=a.CONNECTING,!0===this.automaticOpen&&this.open(!1)}return s.prototype.on=function(e,t,o){if("function"!=typeof t)throw new Error("listener must be a function");this._stores[e]||(this._stores[e]=[]),this._stores[e].push({cb:t,ctx:o})},s.prototype.emit=function(e){var t=this._stores[e];if(t){for(var o=Array.prototype.slice.call(arguments,1),n=0;n<t.length;n++)t[n].cb.apply(t[n].ctx,o);return!0}},s.prototype.off=function(e,t){if(arguments.length){var o=this._stores[e];if(!o)return!1;if(t)for(var n=o.length-1;0<=n;n--)o[n].cb===t&&o.splice(n,1);else this._stores[e]=[]}else this._stores={}},h.CONNECTING=a.CONNECTING,h.OPEN=a.OPEN,h.CLOSING=a.CLOSING,h.CLOSED=a.CLOSED,h.EVENT={OPEN:"open",CLOSE:"close",ERROR:"error",MESSAGE:"message",CONNECTING:"connecting"},h.prototype.open=function(n){var r=this;if(!this.websocket||this.websocket.readyState!==a.OPEN){var s=new WebSocket(this.url,this.protocols);if((this.websocket=s).binaryType=this.binaryType,n){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else this.event.emit(h.EVENT.CONNECTING),this.reconnectAttempts=0;var i=setTimeout(function(){s&&s.close()},this.openTimeoutInterval);s.onopen=function(e){clearTimeout(this.heartCheckTimer),clearTimeout(i),r.protocol=s.protocol,r.readyState=a.OPEN,r.reconnectAttempts=0,r.event.emit(h.EVENT.OPEN,e,{reconnectAttempt:n}),r.heartCheckStart();for(var t=new Date;0<r.messageQueue.length;){var o=r.messageQueue.shift();(r.messageQueueTimeout<=0||t-o.pushTime<=r.messageQueueTimeout)&&r.sendRaw(o.message)}},s.onclose=function(e){if(clearTimeout(this.heartCheckTimer),clearTimeout(i),s=null,r.websocket=null,function(e,t){for(var o=0;o<e.length;o++)if(e[o]===t)return 1}(r.normalCloseCode,e.code))return r.readyState=a.CLOSED,void r.event.emit(h.EVENT.CLOSE,e);r.readyState=a.CONNECTING,r.event.emit(h.EVENT.CONNECTING,e);e=Math.min(r.maxReconnectInterval,r.reconnectInterval*Math.pow(r.reconnectDecay,r.reconnectAttempts));setTimeout(function(){r.reconnectAttempts++,r.open(!0)},e)},s.onmessage=function(e){r.event.emit(h.EVENT.MESSAGE,e.data);try{var t=JSON.parse(e.data);"object"==typeof t&&t[r.typeKey]&&r.event.emit(t[r.typeKey],t[r.payloadKey])}catch(e){}},s.onerror=function(e){r.event.emit(h.EVENT.ERROR,e)}}},h.prototype.on=function(e,t){return this.event.on(e,t,this),this},h.prototype.off=function(e,t){return this.event.off(e,t),this},h.prototype.send=function(e,t){if(!e||"string"!=typeof e)throw TypeError("type must be a string");var o={};return o[this.typeKey]=e,o[this.payloadKey]=t,this.sendRaw(o)},h.prototype.sendRaw=function(e){this.readyState===a.OPEN?this.websocket&&("object"!=typeof e||e instanceof ArrayBuffer||e instanceof Blob?this.websocket.send(e):null==e?this.websocket.send(""):this.websocket.send(JSON.stringify(e))):this.messageQueue.push({pushTime:new Date,message:e})},h.prototype.close=function(e,t){void 0===e&&(e=1e3),this.websocket&&this.websocket.close(e,t)},h.prototype.heartCheckStart=function(){var e;!1!==this.pingInterval&&(e=this,clearTimeout(this.heartCheckTimer),this.heartCheckTimer=setTimeout(function(){e.readyState===a.OPEN&&(e.sendRaw(e.pingData),e.heartCheckStart())},this.pingInterval))},h});