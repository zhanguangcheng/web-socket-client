!function(t,e){"function"==typeof define&&define.amd?define([],e):"undefined"!=typeof module&&module.exports?module.exports=e():t.WebSocketClient=e()}(this,function(){"use strict";var i;if("WebSocket"in window)i=WebSocket;else{if(!("MozWebSocket"in window))throw new Error("you browser do not support WebSocket");i=MozWebSocket}function r(){this._stores={}}function a(t,e){for(var o in this.event=new r,this.websocket=null,this.url="",this.path="",this.query={},this.protocols=void 0,this.automaticOpen=!0,this.reconnectAttempts=0,this.reconnectInterval=1e3,this.reconnectDecay=1.5,this.maxReconnectInterval=3e4,this.maxReconnectAttempts=null,this.openTimeoutInterval=2e3,this.binaryType="blob",this.pingInterval=5e4,this.pingData="ping",this.typeKey="type",this.payloadKey="payload",this.normalCloseCode=[1e3],this.messageQueue=[],this.messageQueueTimeout=3e5,this.protocol=null,this.readyState=null,e=e||{}){if(!this.hasOwnProperty(o))throw new Error('this option "'+o+'" is not defined');this[o]=e[o]}var n,s=function(t){if(!(r=t.match(/^([\w-]+):\/\/([\w.-]+)(?::(\d+))?(\/\w*)?(?:\?([\w=&]+))?(?:#([\w-]+))?$/)))throw new TypeError("url parameter error: "+t);var e=r[1],o=r[2],n=r[3],s=r[4]||"",t=r[5],r=r[6]||"",i={};return t&&t.split("&").forEach(function(t){t=t.split("=");i[t[0]]=t[1]}),{protocol:e,host:o,port:n,path:s,queryParams:i,hash:r}}(t);for(n in this.path&&(s.path=this.path),this.query)s.queryParams[n]=this.query[n];this.url=function(t){var e=t.protocol+"://"+t.host;t.port&&(e+=":"+t.port),t.path&&(e+=t.path);var o,n=[];for(o in t.queryParams){var s=t.queryParams[o];n.push(encodeURIComponent(o)+"="+encodeURIComponent(s))}return 0<n.length&&(e+="?"+n.join("&")),t.hash&&(e+="#"+t.hash),e}(s),this.readyState=i.CONNECTING,!0===this.automaticOpen&&this.open(!1)}return r.prototype.on=function(t,e,o){if("function"!=typeof e)throw new Error("listener must be a function");this._stores[t]||(this._stores[t]=[]),this._stores[t].push({cb:e,ctx:o})},r.prototype.emit=function(t){var e=this._stores[t];if(e){for(var o=Array.prototype.slice.call(arguments,1),n=0;n<e.length;n++)e[n].cb.apply(e[n].ctx,o);return!0}},r.prototype.off=function(t,e){if(arguments.length){var o=this._stores[t];if(!o)return!1;if(e)for(var n=o.length-1;0<=n;n--)o[n].cb===e&&o.splice(n,1);else this._stores[t]=[]}else this._stores={}},a.CONNECTING=i.CONNECTING,a.OPEN=i.OPEN,a.CLOSING=i.CLOSING,a.CLOSED=i.CLOSED,a.EVENT={OPEN:"open",CLOSE:"close",ERROR:"error",MESSAGE:"message",CONNECTING:"connecting"},a.prototype.open=function(t){var n=this;if(!this.websocket||this.websocket.readyState!==i.OPEN){var s=new WebSocket(this.url,this.protocols);if((this.websocket=s).binaryType=this.binaryType,t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else this.event.emit(a.EVENT.CONNECTING),this.reconnectAttempts=0;var r=setTimeout(function(){s&&s.close()},this.openTimeoutInterval);s.onopen=function(t){clearTimeout(r),n.protocol=s.protocol,n.readyState=i.OPEN,n.reconnectAttempts=0,n.event.emit(a.EVENT.OPEN,t),n.heartCheckStart();for(var e=new Date;0<n.messageQueue.length;){var o=n.messageQueue.shift();(n.messageQueueTimeout<=0||e-o.pushTime<=n.messageQueueTimeout)&&n.sendRaw(o.message)}},s.onclose=function(t){if(clearTimeout(r),s=null,n.websocket=null,function(t,e){for(var o=0;o<t.length;o++)if(t[o]===e)return 1}(n.normalCloseCode,t.code))return n.readyState=i.CLOSED,void n.event.emit(a.EVENT.CLOSE,t);n.readyState=i.CONNECTING,n.event.emit(a.EVENT.CONNECTING,t);t=Math.min(n.maxReconnectInterval,n.reconnectInterval*Math.pow(n.reconnectDecay,n.reconnectAttempts));setTimeout(function(){n.reconnectAttempts++,n.open(!0)},t)},s.onmessage=function(t){n.event.emit(a.EVENT.MESSAGE,t.data);try{var e=JSON.parse(t.data);"object"==typeof e&&e[n.typeKey]&&n.event.emit(e[n.typeKey],e[n.payloadKey])}catch(t){}},s.onerror=function(t){n.event.emit(a.EVENT.ERROR,t)}}},a.prototype.on=function(t,e){return this.event.on(t,e,this),this},a.prototype.off=function(t,e){return this.event.off(t,e),this},a.prototype.send=function(t,e){if(!t||"string"!=typeof t)throw TypeError("type must be a string");var o={};return o[this.typeKey]=t,o[this.payloadKey]=e,this.sendRaw(o)},a.prototype.sendRaw=function(t){this.readyState===i.OPEN?this.websocket&&("object"!=typeof t||t instanceof ArrayBuffer||t instanceof Blob?this.websocket.send(t):null==t?this.websocket.send(""):this.websocket.send(JSON.stringify(t))):this.messageQueue.push({pushTime:new Date,message:t})},a.prototype.close=function(t,e){void 0===t&&(t=1e3),this.websocket&&this.websocket.close(t,e)},a.prototype.heartCheckStart=function(){var t;!1!==this.pingInterval&&(t=this,setTimeout(function(){t.readyState===i.OPEN&&(t.sendRaw(t.pingData),t.heartCheckStart())},this.pingInterval))},a});